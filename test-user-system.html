<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户系统测试</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .button { 
            background: #007bff; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
            font-size: 14px;
        }
        .button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .log { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .iframe-container {
            margin: 20px 0;
            border: 2px solid #007bff;
            border-radius: 8px;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 用户系统完整测试</h1>
        
        <!-- 基础连接测试 -->
        <div class="test-section">
            <h2>1️⃣ 基础连接测试</h2>
            <button class="button" onclick="testBasicConnections()">测试所有连接</button>
            <div id="basicResults" class="log"></div>
        </div>

        <!-- API直接测试 -->
        <div class="test-section">
            <h2>2️⃣ API直接测试</h2>
            <button class="button" onclick="testDirectAPI()">直接测试API</button>
            <div id="apiResults" class="log"></div>
        </div>

        <!-- CORS测试 -->
        <div class="test-section">
            <h2>3️⃣ CORS跨域测试</h2>
            <button class="button" onclick="testCORS()">测试CORS</button>
            <div id="corsResults" class="log"></div>
        </div>

        <!-- 应用内嵌测试 -->
        <div class="test-section">
            <h2>4️⃣ 应用内嵌测试</h2>
            <button class="button" onclick="loadApp()">加载应用</button>
            <button class="button" onclick="testInApp()">在应用中测试API</button>
            <div id="appResults" class="log"></div>
            
            <div class="iframe-container" id="appContainer" style="display: none;">
                <iframe id="appFrame" src=""></iframe>
            </div>
        </div>

        <!-- 网络诊断 -->
        <div class="test-section">
            <h2>5️⃣ 网络诊断信息</h2>
            <div id="networkInfo" class="log"></div>
        </div>
    </div>

    <script>
        const API_KEY = '';
        const API_BASE = 'http://yunwu.ai';
        const APP_URL = 'http://localhost:5678';

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testBasicConnections() {
            clearLog('basicResults');
            log('basicResults', '开始基础连接测试...', 'info');

            // 测试本地应用
            try {
                const appResponse = await fetch(APP_URL, { method: 'HEAD' });
                log('basicResults', `✅ 本地应用连接: ${appResponse.status} ${appResponse.statusText}`, 'success');
            } catch (error) {
                log('basicResults', `❌ 本地应用连接失败: ${error.message}`, 'error');
            }

            // 测试API域名
            try {
                const apiResponse = await fetch(`${API_BASE}/v1/models`, { 
                    method: 'HEAD',
                    mode: 'no-cors' 
                });
                log('basicResults', `✅ API域名可访问 (no-cors模式)`, 'success');
            } catch (error) {
                log('basicResults', `❌ API域名访问失败: ${error.message}`, 'error');
            }
        }

        async function testDirectAPI() {
            clearLog('apiResults');
            log('apiResults', '开始直接API测试...', 'info');

            try {
                log('apiResults', `请求URL: ${API_BASE}/v1/models`, 'info');
                log('apiResults', `API Key (前10字符): ${API_KEY.substring(0, 10)}...`, 'info');

                const response = await fetch(`${API_BASE}/v1/models`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                log('apiResults', `响应状态: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                const responseText = await response.text();
                log('apiResults', `响应内容长度: ${responseText.length} 字符`, 'info');

                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        log('apiResults', `✅ API测试成功! 模型数量: ${data.data ? data.data.length : '未知'}`, 'success');
                        if (data.data && data.data.length > 0) {
                            log('apiResults', `前5个模型: ${data.data.slice(0, 5).map(m => m.id).join(', ')}`, 'info');
                        }
                    } catch (parseError) {
                        log('apiResults', `❌ JSON解析失败: ${parseError.message}`, 'error');
                        log('apiResults', `原始响应: ${responseText.substring(0, 500)}...`, 'warning');
                    }
                } else {
                    log('apiResults', `❌ API请求失败: ${responseText}`, 'error');
                }
            } catch (error) {
                log('apiResults', `❌ 网络错误: ${error.message}`, 'error');
                log('apiResults', `错误类型: ${error.name}`, 'error');
                if (error.stack) {
                    log('apiResults', `错误堆栈: ${error.stack}`, 'error');
                }
            }
        }

        async function testCORS() {
            clearLog('corsResults');
            log('corsResults', '开始CORS测试...', 'info');

            // 测试不同的CORS配置
            const tests = [
                { name: '默认模式', options: {} },
                { name: 'cors模式', options: { mode: 'cors' } },
                { name: 'no-cors模式', options: { mode: 'no-cors' } },
                { name: '带credentials', options: { mode: 'cors', credentials: 'include' } }
            ];

            for (const test of tests) {
                try {
                    log('corsResults', `测试: ${test.name}`, 'info');
                    const response = await fetch(`${API_BASE}/v1/models`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        ...test.options
                    });
                    
                    log('corsResults', `✅ ${test.name} - 状态: ${response.status}`, 'success');
                } catch (error) {
                    log('corsResults', `❌ ${test.name} - 错误: ${error.message}`, 'error');
                }
            }
        }

        function loadApp() {
            const container = document.getElementById('appContainer');
            const frame = document.getElementById('appFrame');
            
            frame.src = APP_URL;
            container.style.display = 'block';
            
            log('appResults', '✅ 应用已加载到iframe中', 'success');
            
            // 监听iframe加载事件
            frame.onload = function() {
                log('appResults', '✅ 应用iframe加载完成', 'success');
            };
            
            frame.onerror = function() {
                log('appResults', '❌ 应用iframe加载失败', 'error');
            };
        }

        async function testInApp() {
            clearLog('appResults');
            log('appResults', '开始应用内测试...', 'info');

            const frame = document.getElementById('appFrame');
            if (!frame.src) {
                log('appResults', '❌ 请先加载应用', 'error');
                return;
            }

            try {
                // 通过postMessage与iframe通信
                const testConfig = {
                    type: 'TEST_API',
                    config: {
                        baseUrl: API_BASE,
                        apiKey: API_KEY
                    }
                };

                frame.contentWindow.postMessage(testConfig, APP_URL);
                log('appResults', '✅ 已向应用发送测试消息', 'success');

                // 监听应用的回复
                window.addEventListener('message', function(event) {
                    if (event.origin !== APP_URL) return;
                    
                    log('appResults', `收到应用回复: ${JSON.stringify(event.data)}`, 'info');
                });

            } catch (error) {
                log('appResults', `❌ 应用内测试失败: ${error.message}`, 'error');
            }
        }

        // 显示网络诊断信息
        function showNetworkInfo() {
            const info = document.getElementById('networkInfo');
            info.innerHTML = `
用户代理: ${navigator.userAgent}
当前页面: ${location.href}
测试时间: ${new Date().toISOString()}
浏览器支持:
- Fetch API: ${typeof fetch !== 'undefined' ? '✅' : '❌'}
- WebSockets: ${typeof WebSocket !== 'undefined' ? '✅' : '❌'}
- Local Storage: ${typeof localStorage !== 'undefined' ? '✅' : '❌'}
- Session Storage: ${typeof sessionStorage !== 'undefined' ? '✅' : '❌'}

网络状态: ${navigator.onLine ? '在线' : '离线'}
连接类型: ${navigator.connection ? navigator.connection.effectiveType : '未知'}
            `;
        }

        // 页面加载完成后显示网络信息
        window.onload = function() {
            showNetworkInfo();
            log('basicResults', '测试页面已就绪', 'success');
        };
    </script>
</body>
</html> 