<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç³»ç»Ÿæµ‹è¯•</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .button { 
            background: #007bff; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
            font-size: 14px;
        }
        .button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .log { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .iframe-container {
            margin: 20px 0;
            border: 2px solid #007bff;
            border-radius: 8px;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç”¨æˆ·ç³»ç»Ÿå®Œæ•´æµ‹è¯•</h1>
        
        <!-- åŸºç¡€è¿æ¥æµ‹è¯• -->
        <div class="test-section">
            <h2>1ï¸âƒ£ åŸºç¡€è¿æ¥æµ‹è¯•</h2>
            <button class="button" onclick="testBasicConnections()">æµ‹è¯•æ‰€æœ‰è¿æ¥</button>
            <div id="basicResults" class="log"></div>
        </div>

        <!-- APIç›´æ¥æµ‹è¯• -->
        <div class="test-section">
            <h2>2ï¸âƒ£ APIç›´æ¥æµ‹è¯•</h2>
            <button class="button" onclick="testDirectAPI()">ç›´æ¥æµ‹è¯•API</button>
            <div id="apiResults" class="log"></div>
        </div>

        <!-- CORSæµ‹è¯• -->
        <div class="test-section">
            <h2>3ï¸âƒ£ CORSè·¨åŸŸæµ‹è¯•</h2>
            <button class="button" onclick="testCORS()">æµ‹è¯•CORS</button>
            <div id="corsResults" class="log"></div>
        </div>

        <!-- åº”ç”¨å†…åµŒæµ‹è¯• -->
        <div class="test-section">
            <h2>4ï¸âƒ£ åº”ç”¨å†…åµŒæµ‹è¯•</h2>
            <button class="button" onclick="loadApp()">åŠ è½½åº”ç”¨</button>
            <button class="button" onclick="testInApp()">åœ¨åº”ç”¨ä¸­æµ‹è¯•API</button>
            <div id="appResults" class="log"></div>
            
            <div class="iframe-container" id="appContainer" style="display: none;">
                <iframe id="appFrame" src=""></iframe>
            </div>
        </div>

        <!-- ç½‘ç»œè¯Šæ–­ -->
        <div class="test-section">
            <h2>5ï¸âƒ£ ç½‘ç»œè¯Šæ–­ä¿¡æ¯</h2>
            <div id="networkInfo" class="log"></div>
        </div>
    </div>

    <script>
        const API_KEY = '';
        const API_BASE = 'http://yunwu.ai';
        const APP_URL = 'http://localhost:5678';

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testBasicConnections() {
            clearLog('basicResults');
            log('basicResults', 'å¼€å§‹åŸºç¡€è¿æ¥æµ‹è¯•...', 'info');

            // æµ‹è¯•æœ¬åœ°åº”ç”¨
            try {
                const appResponse = await fetch(APP_URL, { method: 'HEAD' });
                log('basicResults', `âœ… æœ¬åœ°åº”ç”¨è¿æ¥: ${appResponse.status} ${appResponse.statusText}`, 'success');
            } catch (error) {
                log('basicResults', `âŒ æœ¬åœ°åº”ç”¨è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }

            // æµ‹è¯•APIåŸŸå
            try {
                const apiResponse = await fetch(`${API_BASE}/v1/models`, { 
                    method: 'HEAD',
                    mode: 'no-cors' 
                });
                log('basicResults', `âœ… APIåŸŸåå¯è®¿é—® (no-corsæ¨¡å¼)`, 'success');
            } catch (error) {
                log('basicResults', `âŒ APIåŸŸåè®¿é—®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testDirectAPI() {
            clearLog('apiResults');
            log('apiResults', 'å¼€å§‹ç›´æ¥APIæµ‹è¯•...', 'info');

            try {
                log('apiResults', `è¯·æ±‚URL: ${API_BASE}/v1/models`, 'info');
                log('apiResults', `API Key (å‰10å­—ç¬¦): ${API_KEY.substring(0, 10)}...`, 'info');

                const response = await fetch(`${API_BASE}/v1/models`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                log('apiResults', `å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                const responseText = await response.text();
                log('apiResults', `å“åº”å†…å®¹é•¿åº¦: ${responseText.length} å­—ç¬¦`, 'info');

                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        log('apiResults', `âœ… APIæµ‹è¯•æˆåŠŸ! æ¨¡å‹æ•°é‡: ${data.data ? data.data.length : 'æœªçŸ¥'}`, 'success');
                        if (data.data && data.data.length > 0) {
                            log('apiResults', `å‰5ä¸ªæ¨¡å‹: ${data.data.slice(0, 5).map(m => m.id).join(', ')}`, 'info');
                        }
                    } catch (parseError) {
                        log('apiResults', `âŒ JSONè§£æå¤±è´¥: ${parseError.message}`, 'error');
                        log('apiResults', `åŸå§‹å“åº”: ${responseText.substring(0, 500)}...`, 'warning');
                    }
                } else {
                    log('apiResults', `âŒ APIè¯·æ±‚å¤±è´¥: ${responseText}`, 'error');
                }
            } catch (error) {
                log('apiResults', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
                log('apiResults', `é”™è¯¯ç±»å‹: ${error.name}`, 'error');
                if (error.stack) {
                    log('apiResults', `é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
                }
            }
        }

        async function testCORS() {
            clearLog('corsResults');
            log('corsResults', 'å¼€å§‹CORSæµ‹è¯•...', 'info');

            // æµ‹è¯•ä¸åŒçš„CORSé…ç½®
            const tests = [
                { name: 'é»˜è®¤æ¨¡å¼', options: {} },
                { name: 'corsæ¨¡å¼', options: { mode: 'cors' } },
                { name: 'no-corsæ¨¡å¼', options: { mode: 'no-cors' } },
                { name: 'å¸¦credentials', options: { mode: 'cors', credentials: 'include' } }
            ];

            for (const test of tests) {
                try {
                    log('corsResults', `æµ‹è¯•: ${test.name}`, 'info');
                    const response = await fetch(`${API_BASE}/v1/models`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        ...test.options
                    });
                    
                    log('corsResults', `âœ… ${test.name} - çŠ¶æ€: ${response.status}`, 'success');
                } catch (error) {
                    log('corsResults', `âŒ ${test.name} - é”™è¯¯: ${error.message}`, 'error');
                }
            }
        }

        function loadApp() {
            const container = document.getElementById('appContainer');
            const frame = document.getElementById('appFrame');
            
            frame.src = APP_URL;
            container.style.display = 'block';
            
            log('appResults', 'âœ… åº”ç”¨å·²åŠ è½½åˆ°iframeä¸­', 'success');
            
            // ç›‘å¬iframeåŠ è½½äº‹ä»¶
            frame.onload = function() {
                log('appResults', 'âœ… åº”ç”¨iframeåŠ è½½å®Œæˆ', 'success');
            };
            
            frame.onerror = function() {
                log('appResults', 'âŒ åº”ç”¨iframeåŠ è½½å¤±è´¥', 'error');
            };
        }

        async function testInApp() {
            clearLog('appResults');
            log('appResults', 'å¼€å§‹åº”ç”¨å†…æµ‹è¯•...', 'info');

            const frame = document.getElementById('appFrame');
            if (!frame.src) {
                log('appResults', 'âŒ è¯·å…ˆåŠ è½½åº”ç”¨', 'error');
                return;
            }

            try {
                // é€šè¿‡postMessageä¸iframeé€šä¿¡
                const testConfig = {
                    type: 'TEST_API',
                    config: {
                        baseUrl: API_BASE,
                        apiKey: API_KEY
                    }
                };

                frame.contentWindow.postMessage(testConfig, APP_URL);
                log('appResults', 'âœ… å·²å‘åº”ç”¨å‘é€æµ‹è¯•æ¶ˆæ¯', 'success');

                // ç›‘å¬åº”ç”¨çš„å›å¤
                window.addEventListener('message', function(event) {
                    if (event.origin !== APP_URL) return;
                    
                    log('appResults', `æ”¶åˆ°åº”ç”¨å›å¤: ${JSON.stringify(event.data)}`, 'info');
                });

            } catch (error) {
                log('appResults', `âŒ åº”ç”¨å†…æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºç½‘ç»œè¯Šæ–­ä¿¡æ¯
        function showNetworkInfo() {
            const info = document.getElementById('networkInfo');
            info.innerHTML = `
ç”¨æˆ·ä»£ç†: ${navigator.userAgent}
å½“å‰é¡µé¢: ${location.href}
æµ‹è¯•æ—¶é—´: ${new Date().toISOString()}
æµè§ˆå™¨æ”¯æŒ:
- Fetch API: ${typeof fetch !== 'undefined' ? 'âœ…' : 'âŒ'}
- WebSockets: ${typeof WebSocket !== 'undefined' ? 'âœ…' : 'âŒ'}
- Local Storage: ${typeof localStorage !== 'undefined' ? 'âœ…' : 'âŒ'}
- Session Storage: ${typeof sessionStorage !== 'undefined' ? 'âœ…' : 'âŒ'}

ç½‘ç»œçŠ¶æ€: ${navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿'}
è¿æ¥ç±»å‹: ${navigator.connection ? navigator.connection.effectiveType : 'æœªçŸ¥'}
            `;
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºç½‘ç»œä¿¡æ¯
        window.onload = function() {
            showNetworkInfo();
            log('basicResults', 'æµ‹è¯•é¡µé¢å·²å°±ç»ª', 'success');
        };
    </script>
</body>
</html> 