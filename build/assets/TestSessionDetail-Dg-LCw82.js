import{r as i,I as _,_ as H,ah as Y,bH as Z,bF as ee,ao as e,bI as te,ap as g,aq as se,ar as d,as as S,at as u,az as re,an as o,aA as L}from"./index-CFiG4jUx.js";import{c as ne,e as le,a as ae,b as oe}from"./export-AE7HwFIg.js";import{T as $}from"./index-BtKM4wLR.js";import{S as C,R as z}from"./index-BXFIHTMJ.js";import{R as ie}from"./useBreakpoint-BeMf8Kwx.js";import{a as E,F as ce}from"./Table-BajktlNK.js";import{I as de}from"./index-BIFbDk8c.js";import{R as M}from"./DownloadOutlined-_TPnELU8.js";var ue={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M872 474H286.9l350.2-304c5.6-4.9 2.2-14-5.2-14h-88.5c-3.9 0-7.6 1.4-10.5 3.9L155 487.8a31.96 31.96 0 000 48.3L535.1 866c1.5 1.3 3.3 2 5.2 2h91.5c7.4 0 10.8-9.2 5.2-14L286.9 550H872c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"}}]},name:"arrow-left",theme:"outlined"},me=function(m,p){return i.createElement(_,H({},m,{ref:p,icon:ue}))},xe=i.forwardRef(me),he={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M699 353h-46.9c-10.2 0-19.9 4.9-25.9 13.3L469 584.3l-71.2-98.8c-6-8.3-15.6-13.3-25.9-13.3H325c-6.5 0-10.3 7.4-6.5 12.7l124.6 172.8a31.8 31.8 0 0051.7 0l210.6-292c3.9-5.3.1-12.7-6.4-12.7z"}},{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"}}]},name:"check-circle",theme:"outlined"},ge=function(m,p){return i.createElement(_,H({},m,{ref:p,icon:he}))},pe=i.forwardRef(ge);const{Title:fe,Text:h}=se,{Search:je}=de,Ie=()=>{const{t}=Y(),{sessionId:m}=Z(),p=ee(),[n,j]=i.useState(null),[O,N]=i.useState(!0),[b,F]=i.useState(""),[x,y]=i.useState([]),[A,w]=i.useState(!1),[c,B]=i.useState(null),T=()=>{p("/test-history")},V=async()=>{if(m){N(!0);try{if(m.startsWith("temp-")){const l=localStorage.getItem("temp_session_detail");if(l){const a=JSON.parse(l);j(a);return}}const r=(await L.getTestSessionHistory(1e3)).find(l=>l.id===m);r?j(r):(o.error(t("history.sessionNotFound")),T())}catch(s){console.error("加载测试记录详情失败:",s),o.error(t("history.loadFailed"))}finally{N(!1)}}},I=async(s,r)=>{try{const l=L.getCurrentUserId();if(!l)return!1;const a=`${l}_test_session_history`,f=localStorage.getItem(a);if(!f)return!1;const v=JSON.parse(f),k=v.findIndex(X=>X.id===s);return k===-1?!1:(v[k]=r,localStorage.setItem(a,JSON.stringify(v)),!0)}catch(l){return console.error("更新测试会话历史失败:",l),!1}},D=(n==null?void 0:n.results.filter(s=>{var r,l,a;return((r=s.userInput)==null?void 0:r.toLowerCase().includes(b.toLowerCase()))||((l=s.output)==null?void 0:l.toLowerCase().includes(b.toLowerCase()))||((a=s.errorMessage)==null?void 0:a.toLowerCase().includes(b.toLowerCase()))}))||[],q=async s=>{if(n)try{const r=n.results.filter(a=>a.id!==s),l={...n,results:r};await I(n.id,l),j(l),o.success(t("common.deleteSuccess"))}catch(r){console.error("删除结果失败:",r),o.error(t("common.deleteFailed"))}},J=async()=>{if(!(!n||x.length===0))try{const s=n.results.filter(l=>!x.includes(l.id)),r={...n,results:s};await I(n.id,r),j(r),y([]),o.success(t("common.batchDeleteSuccess",{count:x.length}))}catch(s){console.error("批量删除失败:",s),o.error(t("common.batchDeleteFailed"))}},R=s=>{ne(s),o.success(t("testing.contentCopied"))},K=()=>{if(!(n!=null&&n.results)||n.results.length===0){o.warning(t("testing.noDataToCopy"));return}oe(n.results),o.success(t("testing.resultsCopied"))},P=()=>{if(!(n!=null&&n.results)||n.results.length===0){o.warning(t("testing.noDataToExport"));return}le(n.results),o.success(t("testing.excelExportSuccess"))},W=()=>{if(!(n!=null&&n.results)||n.results.length===0){o.warning(t("testing.noDataToExport"));return}ae(n.results),o.success(t("testing.csvExportSuccess"))},Q=s=>{B(s),w(!0)},U=[{title:"#",dataIndex:"index",key:"index",width:60,fixed:"left",render:(s,r,l)=>l+1},{title:t("testing.status"),dataIndex:"status",key:"status",width:100,render:s=>e.jsx($,{color:s==="success"?"green":"red",icon:s==="success"?e.jsx(pe,{}):e.jsx(te,{}),children:t(s==="success"?"status.success":"status.failed")})},{title:t("testing.input"),dataIndex:"userInput",key:"userInput",ellipsis:{showTitle:!1},render:s=>e.jsx(g,{placement:"topLeft",title:s,children:e.jsx(h,{style:{maxWidth:200},children:s})})},{title:t("testing.output"),dataIndex:"output",key:"output",ellipsis:{showTitle:!1},render:(s,r)=>r.status==="success"?e.jsx(g,{placement:"topLeft",title:s,children:e.jsx(h,{style:{maxWidth:300},children:s})}):e.jsx(g,{placement:"topLeft",title:r.errorMessage,children:e.jsx(h,{type:"danger",style:{maxWidth:300},children:r.errorMessage})})},{title:"请求耗时",dataIndex:"requestDuration",key:"requestDuration",width:90,render:s=>s?`${s}ms`:"-"},{title:"处理耗时",dataIndex:"processingDuration",key:"processingDuration",width:90,render:(s,r)=>{if(s&&s>0)return`${s}ms`;const l=(r==null?void 0:r.duration)||0,a=(r==null?void 0:r.requestDuration)||0,f=l-a;return f>0?`${f}ms`:"-"}},{title:t("testing.timestampField"),dataIndex:"timestamp",key:"timestamp",width:120,render:s=>new Date(s).toLocaleTimeString()},{title:t("common.actions"),key:"actions",width:150,fixed:"right",render:(s,r)=>e.jsxs(C,{size:"small",children:[e.jsx(g,{title:t("common.viewDetails"),children:e.jsx(d,{type:"text",icon:e.jsx(ie,{}),size:"small",onClick:()=>Q(r),className:"text-blue-500 hover:bg-blue-50"})}),e.jsx(g,{title:t("common.copy"),children:e.jsx(d,{type:"text",icon:e.jsx(S,{}),size:"small",onClick:()=>R(r),className:"text-green-500 hover:bg-green-50"})}),e.jsx(g,{title:t("common.delete"),children:e.jsx(E,{title:t("common.confirmDelete"),onConfirm:()=>q(r.id),okText:t("common.confirm"),cancelText:t("common.cancel"),children:e.jsx(d,{type:"text",danger:!0,icon:e.jsx(z,{}),size:"small",className:"text-red-500 hover:bg-red-50"})})})]})}],G={selectedRowKeys:x,onChange:s=>{y(s)},onSelectAll:(s,r,l)=>{y(s?D.map(a=>a.id):[])}};return i.useEffect(()=>{V()},[m]),O?e.jsx("div",{className:"p-6",children:"加载中..."}):n?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(d,{icon:e.jsx(xe,{}),onClick:T,size:"large",children:t("common.back")}),e.jsxs("div",{children:[e.jsx(fe,{level:2,style:{margin:0},children:n.sessionName}),e.jsxs(C,{className:"mt-2",children:[e.jsx($,{color:n.status==="completed"?"green":n.status==="stopped"?"orange":"red",children:t(`status.${n.status}`)}),e.jsxs(h,{type:"secondary",children:[new Date(n.startTime).toLocaleString()," - ",new Date(n.endTime).toLocaleString()]})]})]})]})})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(u,{className:"bg-blue-50 border-blue-200",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:n.totalTests}),e.jsx("div",{className:"text-sm text-gray-500",children:t("history.totalTests")})]})}),e.jsx(u,{className:"bg-green-50 border-green-200",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:n.successCount}),e.jsx("div",{className:"text-sm text-gray-500",children:t("history.successCount")})]})}),e.jsx(u,{className:"bg-red-50 border-red-200",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:n.errorCount}),e.jsx("div",{className:"text-sm text-gray-500",children:t("history.errorCount")})]})}),e.jsx(u,{className:"bg-purple-50 border-purple-200",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:Math.round(n.averageDuration)}),e.jsxs("div",{className:"text-sm text-gray-500",children:[t("history.averageDuration"),"(ms)"]})]})})]}),e.jsx(u,{title:t("testing.results"),className:"shadow-sm border-gray-200",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0",children:[e.jsx(je,{placeholder:t("common.searchPlaceholder"),allowClear:!0,style:{width:300},onChange:s=>F(s.target.value)}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[x.length>0&&e.jsx(E,{title:t("common.confirmBatchDelete",{count:x.length}),onConfirm:J,okText:t("common.confirm"),cancelText:t("common.cancel"),children:e.jsxs(d,{danger:!0,icon:e.jsx(z,{}),children:[t("common.batchDelete")," (",x.length,")"]})}),e.jsx(d,{icon:e.jsx(M,{}),onClick:P,className:"bg-green-50 text-green-600 border-green-200 hover:bg-green-100",children:t("testing.exportExcel")}),e.jsx(d,{icon:e.jsx(M,{}),onClick:W,className:"bg-blue-50 text-blue-600 border-blue-200 hover:bg-blue-100",children:t("testing.exportCSV")}),e.jsx(d,{icon:e.jsx(S,{}),onClick:K,className:"bg-purple-50 text-purple-600 border-purple-200 hover:bg-purple-100",children:t("testing.copyResults")})]})]}),e.jsx(ce,{rowSelection:G,columns:U,dataSource:D,rowKey:"id",size:"middle",scroll:{x:1200},pagination:{pageSize:20,showSizeChanger:!0,showQuickJumper:!0,showTotal:(s,r)=>`${r[0]}-${r[1]} / ${s} ${t("common.items")}`},className:"custom-table",rowClassName:s=>{const r="hover:bg-blue-50 transition-colors";return s.status==="success"?`${r} border-l-4 border-l-green-500`:s.status==="error"?`${r} border-l-4 border-l-red-500`:r}})]})}),e.jsx(re,{title:t("common.viewDetails"),open:A,onCancel:()=>w(!1),footer:[e.jsx(d,{icon:e.jsx(S,{}),onClick:()=>c&&R(c),children:t("common.copy")},"copy"),e.jsx(d,{onClick:()=>w(!1),children:t("common.close")},"close")],width:800,children:c&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(u,{title:t("testing.input"),size:"small",children:e.jsx(h,{children:c.userInput})}),c.status==="success"?e.jsx(u,{title:t("testing.output"),size:"small",children:e.jsx(h,{children:c.output})}):e.jsx(u,{title:t("common.error"),size:"small",children:e.jsx(h,{type:"danger",children:c.errorMessage})}),e.jsx(u,{title:t("testing.metadata"),size:"small",children:e.jsxs(C,{direction:"vertical",children:[e.jsxs("div",{children:[e.jsxs("strong",{children:[t("testing.status"),":"]})," ",c.status]}),e.jsxs("div",{children:[e.jsxs("strong",{children:[t("testing.duration"),":"]})," ",c.duration,"ms"]}),e.jsxs("div",{children:[e.jsxs("strong",{children:[t("testing.timestamp"),":"]})," ",new Date(c.timestamp).toLocaleString()]})]})})]})})]}):e.jsx("div",{className:"p-6",children:"测试记录不存在"})};export{Ie as default};
