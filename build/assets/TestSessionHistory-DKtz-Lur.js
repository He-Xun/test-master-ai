import{ah as ne,bF as ae,r as c,ao as e,aq as oe,ap as F,ar as o,bG as ce,at as m,az as N,an as a,as as B,aK as f,aA as T,aI as de}from"./index-CFiG4jUx.js";import{e as K,a as O,b as _}from"./export-AE7HwFIg.js";import{S as d,R as A}from"./index-BXFIHTMJ.js";import{T as h}from"./index-BtKM4wLR.js";import{R as xe}from"./useBreakpoint-BeMf8Kwx.js";import{a as J,F as D}from"./Table-BajktlNK.js";import{R as y}from"./DownloadOutlined-_TPnELU8.js";import{I as he}from"./index-BIFbDk8c.js";import{R as ue}from"./ReloadOutlined-36gt7DSb.js";const{Title:Ce,Text:l}=oe,{Search:me}=he,Ne=({visible:w=!0,onClose:Y,asPage:j=!1})=>{var L,P,H,M,V,q;const{t:i}=ne(),G=ae(),[v,Q]=c.useState([]),[S,b]=c.useState([]),[z,p]=c.useState(!1),[t,U]=c.useState(null),[$,I]=c.useState(!1),[W,X]=c.useState(""),[x,k]=c.useState([]),g=async()=>{p(!0);try{const s=await T.getTestSessionHistory(100);Q(s),b(s)}catch(s){console.error("加载测试历史失败:",s)}finally{p(!1)}},Z=s=>{if(X(s),!s.trim())b(v);else{const r=v.filter(n=>n.sessionName.toLowerCase().includes(s.toLowerCase())||n.status.toLowerCase().includes(s.toLowerCase()));b(r)}},ee=async s=>{try{await T.deleteTestSessionHistory(s)?(await g(),a.success(i("history.deleteSuccess"))):a.error(i("history.deleteFailed"))}catch(r){console.error("删除历史记录失败:",r),a.error(i("history.deleteFailed"))}},se=async()=>{try{p(!0);for(const s of x)await T.deleteTestSessionHistory(s);await g(),k([]),a.success(`已删除 ${x.length} 条记录`)}catch(s){console.error("批量删除失败:",s),a.error("批量删除失败")}finally{p(!1)}},te=s=>{j?G(`/test-session-detail/${s.id}`):(U(s),I(!0))},R=s=>new Date(s).toLocaleString("zh-CN"),re=s=>{const n={completed:{color:"green",text:i("status.completed")},stopped:{color:"orange",text:i("status.stopped")},error:{color:"red",text:i("status.error")}}[s]||{color:"default",text:s};return e.jsx(h,{color:n.color,children:n.text})},ie=[{title:i("history.sessionName"),dataIndex:"sessionName",key:"sessionName",ellipsis:!0,render:(s,r)=>e.jsxs(d,{direction:"vertical",size:"small",children:[e.jsx(l,{strong:!0,children:s}),re(r.status)]})},{title:i("history.testTime"),key:"time",width:180,render:s=>e.jsxs(d,{direction:"vertical",size:"small",children:[e.jsx(l,{type:"secondary",style:{fontSize:"12px"},children:R(s.startTime)}),e.jsx(l,{type:"secondary",style:{fontSize:"12px"},children:R(s.endTime)})]})},{title:i("history.statistics"),key:"stats",width:200,render:s=>e.jsxs(d,{size:"small",children:[e.jsxs(h,{color:"blue",children:[i("history.total"),": ",s.totalTests]}),e.jsxs(h,{color:"green",children:[i("history.success"),": ",s.successCount]}),e.jsxs(h,{color:"red",children:[i("history.failed"),": ",s.errorCount]})]})},{title:i("history.averageDuration"),dataIndex:"averageDuration",key:"averageDuration",width:120,render:s=>`${Math.round(s)}ms`},{title:i("common.actions"),key:"actions",width:150,render:s=>e.jsxs(d,{size:"small",children:[e.jsx(F,{title:i("history.viewDetails"),children:e.jsx(o,{type:"text",icon:e.jsx(xe,{}),onClick:()=>te(s)})}),e.jsx(J,{title:i("history.confirmDelete"),onConfirm:()=>ee(s.id),okText:i("common.confirm"),cancelText:i("common.cancel"),children:e.jsx(F,{title:i("common.delete"),children:e.jsx(o,{type:"text",danger:!0,icon:e.jsx(A,{})})})})]})}],le={selectedRowKeys:x,onChange:s=>{k(s)}};c.useEffect(()=>{(j||w)&&g()},[w,j]);const E=()=>e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0",children:[e.jsx(me,{placeholder:"搜索测试记录...",allowClear:!0,style:{width:300},onChange:s=>Z(s.target.value),prefix:e.jsx(de,{})}),e.jsxs(d,{children:[e.jsx(o,{icon:e.jsx(ue,{}),onClick:g,loading:z,children:i("common.refresh")}),x.length>0&&e.jsx(J,{title:`确认删除选中的 ${x.length} 条记录？`,onConfirm:se,okText:i("common.confirm"),cancelText:i("common.cancel"),children:e.jsxs(o,{danger:!0,icon:e.jsx(A,{}),children:["批量删除 (",x.length,")"]})})]})]}),S.length===0?e.jsx(f,{description:W?"没有匹配的记录":i("history.noRecords"),image:f.PRESENTED_IMAGE_SIMPLE}):e.jsx(D,{rowSelection:le,columns:ie,dataSource:S,rowKey:"id",loading:z,pagination:{pageSize:10,showSizeChanger:!0,showQuickJumper:!0,showTotal:(s,r)=>`${r[0]}-${r[1]} / ${s} 条记录`},size:"middle"})]});return j?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-lg flex items-center justify-center",children:e.jsx(ce,{className:"text-white text-xl"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:i("history.title")}),e.jsx("p",{className:"text-gray-500 mt-1",children:i("history.subtitle")})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:v.length}),e.jsx("div",{className:"text-sm text-gray-500",children:i("history.records")})]})]})}),e.jsx(m,{className:"shadow-sm border-gray-200",children:e.jsx(E,{})}),e.jsx(N,{title:`${i("history.testDetails")} - ${t==null?void 0:t.sessionName}`,open:$,onCancel:()=>I(!1),footer:null,width:1e3,destroyOnClose:!0,children:t&&e.jsxs("div",{children:[e.jsxs("div",{style:{background:"#f0f0f0",padding:"8px",marginBottom:"16px",fontSize:"12px"},children:[e.jsx("strong",{children:"调试信息:"}),"会话ID: ",t.id,", 结果数量: ",((L=t.results)==null?void 0:L.length)||0,", 状态: ",t.status,((P=t.results)==null?void 0:P.length)>0&&e.jsxs("div",{children:["第一个结果: ",JSON.stringify(t.results[0],null,2)]})]}),e.jsx(m,{title:i("history.testConfiguration"),size:"small",style:{marginBottom:16},children:e.jsxs(d,{direction:"vertical",style:{width:"100%"},children:[e.jsxs("div",{children:[e.jsxs(l,{strong:!0,children:[i("history.promptId"),": "]}),e.jsx(l,{children:t.testParams.promptId})]}),e.jsxs("div",{children:[e.jsxs(l,{strong:!0,children:[i("history.modelId"),": "]}),e.jsx(l,{children:t.testParams.modelId})]}),e.jsxs("div",{children:[e.jsxs(l,{strong:!0,children:[i("history.repetitions"),": "]}),e.jsx(l,{children:t.testParams.repetitions})]}),e.jsxs("div",{children:[e.jsxs(l,{strong:!0,children:[i("history.interval"),": "]}),e.jsxs(l,{children:[t.testParams.interval,"ms"]})]}),e.jsxs("div",{children:[e.jsxs(l,{strong:!0,children:[i("history.testInputs"),": "]}),e.jsx(l,{children:(H=t.testParams.userInputs)==null?void 0:H.join(", ")})]})]})}),e.jsxs(m,{title:"测试结果",size:"small",children:[e.jsxs("div",{className:"mb-4 flex justify-end space-x-2",children:[e.jsx(o,{size:"small",icon:e.jsx(y,{}),onClick:()=>{t!=null&&t.results&&(K(t.results),a.success("Excel导出成功"))},className:"bg-green-50 text-green-600 border-green-200 hover:bg-green-100",children:"导出Excel"}),e.jsx(o,{size:"small",icon:e.jsx(y,{}),onClick:()=>{t!=null&&t.results&&(O(t.results),a.success("CSV导出成功"))},className:"bg-blue-50 text-blue-600 border-blue-200 hover:bg-blue-100",children:"导出CSV"}),e.jsx(o,{size:"small",icon:e.jsx(B,{}),onClick:()=>{t!=null&&t.results&&(_(t.results),a.success("结果已复制到剪贴板"))},className:"bg-purple-50 text-purple-600 border-purple-200 hover:bg-purple-100",children:"复制结果"})]}),e.jsx("div",{style:{maxHeight:"400px",overflowY:"auto"},children:t.results&&t.results.length>0?e.jsx(D,{size:"small",dataSource:t.results,rowKey:"id",pagination:!1,columns:[{title:"#",render:(s,r,n)=>n+1,width:50},{title:"状态",dataIndex:"status",render:s=>e.jsx(h,{color:s==="success"?"green":"red",children:s==="success"?"成功":"失败"}),width:80},{title:"输入",dataIndex:"userInput",ellipsis:!0,width:200},{title:"输出",dataIndex:"output",ellipsis:!0,render:(s,r)=>r&&r.status==="success"?s:r==null?void 0:r.errorMessage},{title:"请求耗时",dataIndex:"requestDuration",render:s=>s?`${s}ms`:"-",width:90},{title:"处理耗时",dataIndex:"processingDuration",render:(s,r)=>{if(s&&s>0)return`${s}ms`;const n=(r==null?void 0:r.duration)||0,C=(r==null?void 0:r.requestDuration)||0,u=n-C;return u>0?`${u}ms`:"-"},width:90},{title:"时间戳",dataIndex:"timestamp",render:s=>new Date(s).toLocaleTimeString(),width:100}]}):e.jsx(f,{description:"暂无测试结果数据"})})]})]})})]}):e.jsxs(e.Fragment,{children:[e.jsx(N,{title:i("history.title"),open:w,onCancel:Y,footer:null,width:1200,destroyOnClose:!0,children:e.jsx("div",{style:{maxHeight:"70vh",overflowY:"auto"},children:e.jsx(E,{})})}),e.jsx(N,{title:`测试详情 - ${t==null?void 0:t.sessionName}`,open:$,onCancel:()=>I(!1),footer:null,width:1e3,destroyOnClose:!0,children:t&&e.jsxs("div",{children:[e.jsxs("div",{style:{background:"#f0f0f0",padding:"8px",marginBottom:"16px",fontSize:"12px"},children:[e.jsx("strong",{children:"调试信息:"}),"会话ID: ",t.id,", 结果数量: ",((M=t.results)==null?void 0:M.length)||0,", 状态: ",t.status,((V=t.results)==null?void 0:V.length)>0&&e.jsxs("div",{children:["第一个结果: ",JSON.stringify(t.results[0],null,2)]})]}),e.jsx(m,{title:i("history.testConfiguration"),size:"small",style:{marginBottom:16},children:e.jsxs(d,{direction:"vertical",style:{width:"100%"},children:[e.jsxs("div",{children:[e.jsx(l,{strong:!0,children:"提示词ID: "}),e.jsx(l,{children:t.testParams.promptId})]}),e.jsxs("div",{children:[e.jsx(l,{strong:!0,children:"模型ID: "}),e.jsx(l,{children:t.testParams.modelId})]}),e.jsxs("div",{children:[e.jsx(l,{strong:!0,children:"重复次数: "}),e.jsx(l,{children:t.testParams.repetitions})]}),e.jsxs("div",{children:[e.jsx(l,{strong:!0,children:"间隔时间: "}),e.jsxs(l,{children:[t.testParams.interval,"ms"]})]}),e.jsxs("div",{children:[e.jsx(l,{strong:!0,children:"测试输入: "}),e.jsx(l,{children:(q=t.testParams.userInputs)==null?void 0:q.join(", ")})]})]})}),e.jsxs(m,{title:"测试结果",size:"small",children:[e.jsxs("div",{className:"mb-4 flex justify-end space-x-2",children:[e.jsx(o,{size:"small",icon:e.jsx(y,{}),onClick:()=>{t!=null&&t.results&&(K(t.results),a.success("Excel导出成功"))},className:"bg-green-50 text-green-600 border-green-200 hover:bg-green-100",children:"导出Excel"}),e.jsx(o,{size:"small",icon:e.jsx(y,{}),onClick:()=>{t!=null&&t.results&&(O(t.results),a.success("CSV导出成功"))},className:"bg-blue-50 text-blue-600 border-blue-200 hover:bg-blue-100",children:"导出CSV"}),e.jsx(o,{size:"small",icon:e.jsx(B,{}),onClick:()=>{t!=null&&t.results&&(_(t.results),a.success("结果已复制到剪贴板"))},className:"bg-purple-50 text-purple-600 border-purple-200 hover:bg-purple-100",children:"复制结果"})]}),e.jsx("div",{style:{maxHeight:"400px",overflowY:"auto"},children:t.results&&t.results.length>0?e.jsx(D,{size:"small",dataSource:t.results,rowKey:"id",pagination:!1,columns:[{title:"#",render:(s,r,n)=>n+1,width:50},{title:"状态",dataIndex:"status",render:s=>e.jsx(h,{color:s==="success"?"green":"red",children:s==="success"?"成功":"失败"}),width:80},{title:"输入",dataIndex:"userInput",ellipsis:!0,width:200},{title:"输出",dataIndex:"output",ellipsis:!0,render:(s,r)=>r&&r.status==="success"?s:r==null?void 0:r.errorMessage},{title:"请求耗时",dataIndex:"requestDuration",render:s=>s?`${s}ms`:"-",width:90},{title:"处理耗时",dataIndex:"processingDuration",render:(s,r)=>{if(s&&s>0)return`${s}ms`;const n=(r==null?void 0:r.duration)||0,C=(r==null?void 0:r.requestDuration)||0,u=n-C;return u>0?`${u}ms`:"-"},width:90},{title:"时间戳",dataIndex:"timestamp",render:s=>new Date(s).toLocaleTimeString(),width:100}]}):e.jsx(f,{description:"暂无测试结果数据"})})]})]})})]})};export{Ne as default};
