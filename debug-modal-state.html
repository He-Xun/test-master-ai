<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API配置Modal状态调试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; }
        .error { color: red; }
        .success { color: green; }
        button { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .step { margin: 10px 0; padding: 10px; background: #f0f8ff; border-left: 4px solid #007bff; }
        .result { margin: 10px 0; padding: 10px; background: #f0fff0; border-left: 4px solid #28a745; }
        .warning { margin: 10px 0; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>API配置Modal状态调试工具</h1>
        <p>此工具用于调试"添加模型后切换tab丢失配置"的问题</p>
        
        <div class="section">
            <h2>复现步骤</h2>
            <div class="step">
                <strong>步骤1:</strong> 访问API配置管理页面 
                <button onclick="step1()">执行</button>
                <div id="step1-result"></div>
            </div>
            
            <div class="step">
                <strong>步骤2:</strong> 点击"添加配置"按钮打开模态框
                <button onclick="step2()">执行</button>
                <div id="step2-result"></div>
            </div>
            
            <div class="step">
                <strong>步骤3:</strong> 填写基本配置
                <button onclick="step3()">执行</button>
                <div id="step3-result"></div>
            </div>
            
            <div class="step">
                <strong>步骤4:</strong> 切换到模型配置tab
                <button onclick="step4()">执行</button>
                <div id="step4-result"></div>
            </div>
            
            <div class="step">
                <strong>步骤5:</strong> 获取可用模型
                <button onclick="step5()">执行</button>
                <div id="step5-result"></div>
            </div>
            
            <div class="step">
                <strong>步骤6:</strong> 选择并添加模型
                <button onclick="step6()">执行</button>
                <div id="step6-result"></div>
            </div>
            
            <div class="step">
                <strong>步骤7:</strong> 切换回基本配置tab
                <button onclick="step7()">执行</button>
                <div id="step7-result"></div>
            </div>
            
            <div class="step">
                <strong>步骤8:</strong> 再次切换到模型配置tab，检查模型是否丢失
                <button onclick="step8()">执行</button>
                <div id="step8-result"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>实时状态监控</h2>
            <button onclick="startMonitoring()">开始监控</button>
            <button onclick="stopMonitoring()">停止监控</button>
            <div id="monitoring-output"></div>
        </div>
        
        <div class="section">
            <h2>表单数据检查</h2>
            <button onclick="checkFormData()">检查当前表单数据</button>
            <div id="form-data-output"></div>
        </div>
    </div>
    
    <script>
        let monitoringInterval = null;
        
        function step1() {
            const result = document.getElementById('step1-result');
            window.open('http://localhost:5678/#/api-config', '_blank');
            result.innerHTML = '<div class="result">已打开API配置管理页面</div>';
        }
        
        function step2() {
            const result = document.getElementById('step2-result');
            result.innerHTML = '<div class="warning">请手动点击页面上的"添加配置"按钮</div>';
        }
        
        function step3() {
            const result = document.getElementById('step3-result');
            result.innerHTML = '<div class="warning">请手动填写配置名称: "测试配置"，选择"API接口"模式，填写Base URL: "https://yunwu.ai/v1", API Key: ""</div>';
        }
        
        function step4() {
            const result = document.getElementById('step4-result');
            result.innerHTML = '<div class="warning">请手动切换到"模型配置"标签页</div>';
        }
        
        function step5() {
            const result = document.getElementById('step5-result');
            result.innerHTML = '<div class="warning">请手动点击"获取模型"按钮</div>';
        }
        
        function step6() {
            const result = document.getElementById('step6-result');
            result.innerHTML = '<div class="warning">请手动选择几个模型并点击"添加选中"按钮</div>';
        }
        
        function step7() {
            const result = document.getElementById('step7-result');
            result.innerHTML = '<div class="warning">请手动切换回"基本配置"标签页</div>';
        }
        
        function step8() {
            const result = document.getElementById('step8-result');
            result.innerHTML = '<div class="warning">请手动再次切换到"模型配置"标签页，观察之前添加的模型是否还存在</div>';
        }
        
        function startMonitoring() {
            if (monitoringInterval) return;
            
            const output = document.getElementById('monitoring-output');
            output.innerHTML = '<div class="result">开始监控localStorage变化...</div>';
            
            let lastStorage = JSON.stringify(localStorage);
            
            monitoringInterval = setInterval(() => {
                const currentStorage = JSON.stringify(localStorage);
                if (currentStorage !== lastStorage) {
                    const now = new Date().toLocaleTimeString();
                    output.innerHTML += `<div class="result">[${now}] localStorage发生变化</div>`;
                    lastStorage = currentStorage;
                }
                
                // 监控控制台消息
                checkConsoleMessages();
            }, 1000);
        }
        
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                const output = document.getElementById('monitoring-output');
                output.innerHTML += '<div class="warning">监控已停止</div>';
            }
        }
        
        function checkFormData() {
            const output = document.getElementById('form-data-output');
            try {
                // 尝试从主窗口获取React DevTools数据
                const apiConfigs = JSON.parse(localStorage.getItem('apiConfigs') || '[]');
                const userSession = JSON.parse(localStorage.getItem('userSession') || 'null');
                
                let userConfigs = [];
                if (userSession && userSession.user && userSession.user.id) {
                    const userKey = `${userSession.user.id}_apiConfigs`;
                    userConfigs = JSON.parse(localStorage.getItem(userKey) || '[]');
                }
                
                output.innerHTML = `
                    <div class="result">
                        <h3>LocalStorage数据：</h3>
                        <pre>全局API配置数量: ${apiConfigs.length}</pre>
                        <pre>用户API配置数量: ${userConfigs.length}</pre>
                        <pre>用户会话: ${userSession ? userSession.user?.username || '匿名' : '未登录'}</pre>
                        <h4>用户配置详情:</h4>
                        <pre>${JSON.stringify(userConfigs, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                output.innerHTML = `<div class="error">检查失败: ${error.message}</div>`;
            }
        }
        
        function checkConsoleMessages() {
            // 这个函数在实际应用中可以监控控制台消息
            // 但在这个调试页面中我们只是占位
        }
        
        // 页面加载时的初始化
        window.onload = function() {
            document.getElementById('monitoring-output').innerHTML = '<div class="warning">点击"开始监控"来监控状态变化</div>';
        };
    </script>
</body>
</html> 