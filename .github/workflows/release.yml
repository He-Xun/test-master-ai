name: Build and Release Electron App

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'å‘å¸ƒç±»å‹'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - official

permissions:
  contents: write
  pages: write
  id-token: write

env:
  NODE_VERSION: '20'

jobs:
  # è·¨å¹³å°æ„å»º - æ¨é€åˆ°mainæˆ–åˆ›å»ºreleaseæ—¶éƒ½è¿è¡Œ
  build:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: mac
            artifact-name: 'macos-build'
            icon-ext: 'icns'
          - os: windows-latest
            platform: win
            artifact-name: 'windows-build'
            icon-ext: 'ico'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies for Windows (batch strategy)
        if: runner.os == 'Windows'
        timeout-minutes: 45
        shell: pwsh
        run: |
          Write-Host "=== Windowsåˆ†æ‰¹ä¾èµ–å®‰è£…ç­–ç•¥ ==="
          
          # åªæ¸…ç†æ—§çš„node_modulesï¼Œä¸æ¸…ç†ç¼“å­˜
          if (Test-Path "node_modules") { 
            Write-Host "æ¸…ç†æ—§çš„node_modules..."
            Remove-Item -Recurse -Force "node_modules" -ErrorAction SilentlyContinue
          }
          
          # ç¬¬ä¸€æ‰¹ï¼šæ ¸å¿ƒæ„å»ºå·¥å…·
          Write-Host "ç¬¬1æ‰¹ï¼šå®‰è£…æ ¸å¿ƒæ„å»ºå·¥å…·..."
          npm install --no-audit --progress=false --no-fund --silent --maxsockets=1 --ignore-scripts --loglevel=error --fetch-retries=5 electron@25.0.0 electron-builder@24.0.0 @electron/rebuild@3.2.13
          
          # ç¬¬äºŒæ‰¹ï¼šå‰ç«¯æ¡†æ¶
          Write-Host "ç¬¬2æ‰¹ï¼šå®‰è£…å‰ç«¯æ¡†æ¶..."
          npm install --no-audit --progress=false --no-fund --silent --maxsockets=1 --ignore-scripts --loglevel=error --fetch-retries=5 react@18.2.0 react-dom@18.2.0 antd@5.21.6
          
          # ç¬¬ä¸‰æ‰¹ï¼šæ„å»ºå·¥å…·
          Write-Host "ç¬¬3æ‰¹ï¼šå®‰è£…æ„å»ºå·¥å…·..."
          npm install --no-audit --progress=false --no-fund --silent --maxsockets=1 --ignore-scripts --loglevel=error --fetch-retries=5 vite@5.2.0 typescript@5.6.3 @vitejs/plugin-react@4.2.1
          
          # ç¬¬å››æ‰¹ï¼šå‰©ä½™ä¾èµ–
          Write-Host "ç¬¬4æ‰¹ï¼šå®‰è£…å‰©ä½™å¼€å‘ä¾èµ–..."
          npm install --no-audit --progress=false --no-fund --silent --maxsockets=1 --ignore-scripts --ignore-optional --loglevel=error --fetch-retries=5
          
          # éªŒè¯å…³é”®ä¾èµ–
          Write-Host "=== éªŒè¯å…³é”®ä¾èµ– ==="
          if (!(Test-Path "node_modules/electron")) { 
            Write-Host "é‡è¯•å®‰è£… electron..."
            npm install --no-audit --progress=false --loglevel=error electron@25.0.0
          }
          if (!(Test-Path "node_modules/electron-builder")) { 
            Write-Host "é‡è¯•å®‰è£… electron-builder..."
            npm install --no-audit --progress=false --loglevel=error electron-builder@24.0.0
          }
          if (!(Test-Path "node_modules/@electron/rebuild/lib/src/search-module.js") -or !(Test-Path "node_modules/@electron/rebuild/out/src/search-module.js")) { 
            Write-Host "âš ï¸ @electron/rebuildæ¨¡å—æ–‡ä»¶ä¸å®Œæ•´ï¼Œå°è¯•å®Œæ•´é‡æ–°å®‰è£…..."
            # å®Œå…¨åˆ é™¤
            npm uninstall @electron/rebuild --silent 2>$null
            # æ¸…ç†npmç¼“å­˜ä¸­çš„æ­¤æ¨¡å—
            npm cache clean --force @electron/rebuild
            # å¼ºåˆ¶ä»æºå®‰è£…
            npm install --no-audit --progress=false --loglevel=error @electron/rebuild@3.2.13 --force --no-save
            
            # å¦‚æœä»ç„¶å¤±è´¥ï¼Œä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆ
            if (!(Test-Path "node_modules/@electron/rebuild/lib/src/search-module.js") -and !(Test-Path "node_modules/@electron/rebuild/out/src/search-module.js")) {
              Write-Host "âŒ æ¨¡å—å®‰è£…ä»ä¸å®Œæ•´ï¼Œå°è¯•æ›¿ä»£è§£å†³æ–¹æ¡ˆ..."
              
              # æ–¹æ¡ˆ1: åˆ›å»ºä¸€ä¸ªç©ºçš„å®ç°ï¼Œé€è¡Œå†™å…¥è€Œä¸ä½¿ç”¨å¤šè¡Œå­—ç¬¦ä¸²
              # ç¡®ä¿ç›®å½•å­˜åœ¨
              New-Item -Path "node_modules/@electron/rebuild/lib/src" -ItemType Directory -Force
              New-Item -Path "node_modules/@electron/rebuild/out/src" -ItemType Directory -Force
              
              # å†™å…¥ç¬¬ä¸€è¡Œ
              Set-Content -Path "node_modules/@electron/rebuild/lib/src/search-module.js" -Value "// Empty implementation of search-module.js"
              # å†™å…¥ç¬¬äºŒè¡Œ
              Add-Content -Path "node_modules/@electron/rebuild/lib/src/search-module.js" -Value "'use strict';"
              # å†™å…¥ç¬¬ä¸‰è¡Œ
              Add-Content -Path "node_modules/@electron/rebuild/lib/src/search-module.js" -Value "Object.defineProperty(exports, '__esModule', { value: true });"
              # å†™å…¥ç¬¬å››è¡Œï¼ˆç©ºè¡Œï¼‰
              Add-Content -Path "node_modules/@electron/rebuild/lib/src/search-module.js" -Value ""
              # å†™å…¥ç¬¬äº”è¡Œå¼€å§‹çš„å‡½æ•°
              Add-Content -Path "node_modules/@electron/rebuild/lib/src/search-module.js" -Value "exports.searchForModule = async function(moduleName, includedPaths, requireFunc) {"
              Add-Content -Path "node_modules/@electron/rebuild/lib/src/search-module.js" -Value "  console.log('Using stub implementation of searchForModule', moduleName);"
              Add-Content -Path "node_modules/@electron/rebuild/lib/src/search-module.js" -Value "  return null;"
              Add-Content -Path "node_modules/@electron/rebuild/lib/src/search-module.js" -Value "};"
              
              # æ·»åŠ getProjectRootPathå‡½æ•°å®ç°
              Add-Content -Path "node_modules/@electron/rebuild/lib/src/search-module.js" -Value "exports.getProjectRootPath = function(moduleName) {"
              Add-Content -Path "node_modules/@electron/rebuild/lib/src/search-module.js" -Value "  console.log('Using stub implementation of getProjectRootPath', moduleName);"
              Add-Content -Path "node_modules/@electron/rebuild/lib/src/search-module.js" -Value "  return process.cwd();"
              Add-Content -Path "node_modules/@electron/rebuild/lib/src/search-module.js" -Value "};"
              
              # åŒæ ·åˆ›å»ºoutç›®å½•ä¸‹çš„ç‰ˆæœ¬ï¼ˆå¤åˆ¶æ–‡ä»¶ï¼‰
              Copy-Item "node_modules/@electron/rebuild/lib/src/search-module.js" -Destination "node_modules/@electron/rebuild/out/src/search-module.js" -Force
              
              Write-Host "âœ… åˆ›å»ºäº†ç©ºå®ç°æ›¿ä»£æ–‡ä»¶"
            }
          }
          
          Write-Host "âœ… Windowsä¾èµ–å®‰è£…å®Œæˆ"
        env:
          npm_config_timeout: 900000  # 15åˆ†é’Ÿè¶…æ—¶
          npm_config_maxsockets: 1    # é™åˆ°æœ€ä½å¹¶å‘
          npm_config_fetch_timeout: 600000  # 10åˆ†é’Ÿè·å–è¶…æ—¶
          npm_config_fetch_retry_mintimeout: 60000
          npm_config_fetch_retry_maxtimeout: 300000
          npm_config_registry: https://registry.npmjs.org/
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true

      - name: Install all dependencies (Unix)
        if: runner.os != 'Windows'
        timeout-minutes: 25
        run: |
          echo "å®‰è£…å®Œæ•´ä¾èµ–ç”¨äºæ„å»º..."
          # ä¸å†æ¸…ç†ç¼“å­˜ï¼Œé¿å…æƒé™é—®é¢˜
          # npm cache clean --force || echo "ç¼“å­˜æ¸…ç†è·³è¿‡"
          # ä½¿ç”¨npm installæ›¿ä»£npm ciï¼Œè§£å†³package.jsonå’Œpackage-lock.jsonä¸åŒæ­¥é—®é¢˜
          npm install --prefer-offline --no-audit --progress=false --no-fund --ignore-scripts --loglevel=error --fetch-retries=5
        env:
          npm_config_timeout: 600000  # 10åˆ†é’Ÿè¶…æ—¶
          npm_config_maxsockets: 2    # é™ä½å¹¶å‘
          npm_config_fetch_timeout: 300000
          npm_config_fetch_retry_mintimeout: 30000
          npm_config_fetch_retry_maxtimeout: 120000
          npm_config_cache: .npm
          npm_config_prefer-offline: true
          npm_config_registry: https://registry.npmjs.org/
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true

      - name: Build renderer process with optimizations
        timeout-minutes: 30
        run: |
          echo "å¼€å§‹Viteæ„å»ºï¼ˆå¯ç”¨ä¼˜åŒ–ï¼‰..."
          npm run build:vite
        env:
          NODE_ENV: production
          CI: true
          # Viteä¼˜åŒ–é€‰é¡¹
          VITE_BUILD_MINIFY: true
          VITE_BUILD_CHUNK_SIZE_WARNING_LIMIT: 2000

      - name: Build main process
        run: npm run build:electron
        env:
          NODE_ENV: production
          CI: true

      - name: Clean up large development dependencies (Unix)
        if: runner.os != 'Windows'
        timeout-minutes: 5
        run: |
          echo "æ¸…ç†å¤§å‹å¼€å‘ä¾èµ–æ–‡ä»¶ï¼Œä½†ä¿ç•™æ„å»ºå¿…éœ€çš„å·¥å…·..."
          # åªåˆ é™¤æ˜ç¡®ä¸éœ€è¦çš„å¤§æ–‡ä»¶ï¼Œä¿ç•™electronå’Œelectron-builder
          rm -rf node_modules/playwright || true
          rm -rf node_modules/puppeteer || true
          rm -rf node_modules/@playwright || true
          rm -rf node_modules/@types/puppeteer || true
          rm -rf node_modules/chromium-bidi || true
          # æ¸…ç†ä¸€äº›å¤§çš„éå¿…éœ€æ–‡ä»¶
          find node_modules -name "*.d.ts" -delete || true
          find node_modules -name "README*" -delete || true
          find node_modules -name "CHANGELOG*" -delete || true
          find node_modules -name "test" -type d -exec rm -rf {} + || true
          find node_modules -name "tests" -type d -exec rm -rf {} + || true
          find node_modules -name "example" -type d -exec rm -rf {} + || true
          find node_modules -name "examples" -type d -exec rm -rf {} + || true
          echo "æ¸…ç†å®Œæˆï¼Œä¿ç•™electronæ„å»ºå¿…éœ€ä¾èµ–"

      - name: Clean up large development dependencies (Windows)
        if: runner.os == 'Windows'
        timeout-minutes: 5
        shell: pwsh
        run: |
          Write-Host "æ¸…ç†å¤§å‹å¼€å‘ä¾èµ–æ–‡ä»¶ï¼Œä½†ä¿ç•™æ„å»ºå¿…éœ€çš„å·¥å…·..."
          # åªåˆ é™¤æ˜ç¡®ä¸éœ€è¦çš„å¤§æ–‡ä»¶ï¼Œä¿ç•™electronå’Œelectron-builder
          if (Test-Path "node_modules/playwright") { Remove-Item -Recurse -Force "node_modules/playwright" -ErrorAction SilentlyContinue }
          if (Test-Path "node_modules/puppeteer") { Remove-Item -Recurse -Force "node_modules/puppeteer" -ErrorAction SilentlyContinue }
          if (Test-Path "node_modules/@playwright") { Remove-Item -Recurse -Force "node_modules/@playwright" -ErrorAction SilentlyContinue }
          if (Test-Path "node_modules/@types/puppeteer") { Remove-Item -Recurse -Force "node_modules/@types/puppeteer" -ErrorAction SilentlyContinue }
          if (Test-Path "node_modules/chromium-bidi") { Remove-Item -Recurse -Force "node_modules/chromium-bidi" -ErrorAction SilentlyContinue }
          
          # æ¸…ç†ä¸€äº›å¤§çš„éå¿…éœ€æ–‡ä»¶
          Get-ChildItem -Path "node_modules" -Filter "*.d.ts" -Recurse | Remove-Item -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path "node_modules" -Filter "README*" -Recurse | Remove-Item -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path "node_modules" -Filter "CHANGELOG*" -Recurse | Remove-Item -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path "node_modules" -Name "test" -Directory -Recurse | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path "node_modules" -Name "tests" -Directory -Recurse | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path "node_modules" -Name "example" -Directory -Recurse | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path "node_modules" -Name "examples" -Directory -Recurse | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "æ¸…ç†å®Œæˆï¼Œä¿ç•™electronæ„å»ºå¿…éœ€ä¾èµ–"

      - name: Optimize build for packaging
        run: npm run optimize:build
        env:
          NODE_ENV: production

      - name: Verify build output (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "=== Build directory contents ==="
          ls -la build/ || echo "Build directory not found"
          echo "=== Dist directory contents ==="  
          ls -la dist/ || echo "Dist directory not found"
          echo "=== Icon files ==="
          ls -la electron/icon.${{ matrix.icon-ext }} || echo "Icon file not found"
          echo "=== Node modules size ==="
          du -sh node_modules/ || echo "Node modules not found"

      - name: Verify build output (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "=== Build directory contents ==="
          if (Test-Path "build") { Get-ChildItem -Path "build" -Force } else { Write-Host "Build directory not found" }
          Write-Host "=== Dist directory contents ==="  
          if (Test-Path "dist") { Get-ChildItem -Path "dist" -Force } else { Write-Host "Dist directory not found" }
          Write-Host "=== Icon files ==="
          if (Test-Path "electron/icon.${{ matrix.icon-ext }}") { Get-ChildItem -Path "electron/icon.${{ matrix.icon-ext }}" -Force } else { Write-Host "Icon file not found" }
          Write-Host "=== Node modules size ==="
          if (Test-Path "node_modules") { [math]::Round((Get-ChildItem -Recurse node_modules | Measure-Object -Property Length -Sum).Sum / 1MB, 2).ToString() + " MB" } else { Write-Host "Node modules not found" }

      - name: Validate Electron Builder Configuration
        run: |
          echo "=== éªŒè¯ Electron Builder é…ç½® ==="
          node -e "
            const config = require('./package.json').build;
            if (!config) throw new Error('Missing build configuration');
            console.log('âœ… Build configuration found');
            console.log('AppId:', config.appId);
            console.log('ProductName:', config.productName);
            console.log('Output Directory:', config.directories?.output);
            if (!config.appId) throw new Error('Missing appId');
            if (!config.productName) throw new Error('Missing productName');
            console.log('âœ… Required fields validated');
          "

      - name: Verify build integrity before packaging (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "=== éªŒè¯æ„å»ºå®Œæ•´æ€§ (Windows) ==="
          Write-Host "æ£€æŸ¥å¿…è¦çš„æ„å»ºæ–‡ä»¶..."
          if (Test-Path "dist/main.js") { Write-Host "âœ… dist/main.js exists" } else { Write-Host "âŒ dist/main.js missing" }
          if (Test-Path "build") { Write-Host "âœ… build directory exists" } else { Write-Host "âŒ build directory missing" }
          if (Test-Path "node_modules") { Write-Host "âœ… node_modules exists" } else { Write-Host "âŒ node_modules missing" }
          
          Write-Host "æ£€æŸ¥å›¾æ ‡æ–‡ä»¶..."
          if (Test-Path "electron/icon.${{ matrix.icon-ext }}") { Write-Host "âœ… Icon file exists" } else { Write-Host "âŒ Icon file missing" }
          
          Write-Host "æ£€æŸ¥å…³é”®æ„å»ºä¾èµ–..."
          if (Test-Path "node_modules/electron") { Write-Host "âœ… electronæ¨¡å—å­˜åœ¨" } else { Write-Host "âŒ electronæ¨¡å—ç¼ºå¤±" }
          if (Test-Path "node_modules/electron-builder") { Write-Host "âœ… electron-builderæ¨¡å—å­˜åœ¨" } else { Write-Host "âŒ electron-builderæ¨¡å—ç¼ºå¤±" }
          
          Write-Host "æ£€æŸ¥å·²æ¸…ç†çš„å¤§æ–‡ä»¶..."
          if (!(Test-Path "node_modules/playwright")) { Write-Host "âœ… playwrightå·²æ¸…ç†" } else { Write-Host "âš ï¸ playwrightä»å­˜åœ¨" }
          if (!(Test-Path "node_modules/puppeteer")) { Write-Host "âœ… puppeteerå·²æ¸…ç†" } else { Write-Host "âš ï¸ puppeteerä»å­˜åœ¨" }
          
          Write-Host "=== æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥å®Œæˆ ==="

      - name: Verify build integrity before packaging (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "=== éªŒè¯æ„å»ºå®Œæ•´æ€§ (Unix) ==="
          echo "æ£€æŸ¥å¿…è¦çš„æ„å»ºæ–‡ä»¶..."
          [ -f dist/main.js ] && echo "âœ… dist/main.js exists" || echo "âŒ dist/main.js missing"
          [ -d build ] && echo "âœ… build directory exists" || echo "âŒ build directory missing"
          [ -d node_modules ] && echo "âœ… node_modules exists" || echo "âŒ node_modules missing"
          
          echo "æ£€æŸ¥å›¾æ ‡æ–‡ä»¶..."
          [ -f electron/icon.${{ matrix.icon-ext }} ] && echo "âœ… Icon file exists" || echo "âŒ Icon file missing"
          
          echo "æ£€æŸ¥å…³é”®æ„å»ºä¾èµ–..."
          [ -d node_modules/electron ] && echo "âœ… electronæ¨¡å—å­˜åœ¨" || echo "âŒ electronæ¨¡å—ç¼ºå¤±"
          [ -d node_modules/electron-builder ] && echo "âœ… electron-builderæ¨¡å—å­˜åœ¨" || echo "âŒ electron-builderæ¨¡å—ç¼ºå¤±"
          
          echo "æ£€æŸ¥å·²æ¸…ç†çš„å¤§æ–‡ä»¶..."
          [ ! -d node_modules/playwright ] && echo "âœ… playwrightå·²æ¸…ç†" || echo "âš ï¸ playwrightä»å­˜åœ¨"
          [ ! -d node_modules/puppeteer ] && echo "âœ… puppeteerå·²æ¸…ç†" || echo "âš ï¸ puppeteerä»å­˜åœ¨"
          
          echo "=== æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥å®Œæˆ ==="

      - name: Build Electron app for macOS
        if: matrix.platform == 'mac'
        timeout-minutes: 45
        run: npx electron-builder --mac --publish never
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          DEBUG: electron-builder
          # ç¦ç”¨macOSå…¬è¯ä»¥é¿å…ç­¾åé—®é¢˜
          CSC_LINK: ""
          CSC_KEY_PASSWORD: ""
          CSC_NAME: ""
          APPLEID: ""
          APPLEIDPASS: ""
          ASC_PROVIDER: ""
          # å®Œå…¨è·³è¿‡ä»£ç ç­¾å
          SKIP_NOTARIZATION: true

      - name: Build Electron app for Windows  
        if: matrix.platform == 'win'
        timeout-minutes: 60
        shell: cmd
        run: |
          @echo off
          
          REM æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„ä»£ç ç­¾åç¯å¢ƒå˜é‡
          set CSC_LINK=
          set WIN_CSC_LINK=
          set CSC_KEY_PASSWORD=
          set WIN_CSC_KEY_PASSWORD=
          set CSC_NAME=
          set WIN_CSC_NAME=
          set CSC_IDENTITY_AUTO_DISCOVERY=false
          set CSC_FOR_PULL_REQUEST=true
          set DEBUG=electron-builder
          
          REM å¼€å§‹æ„å»ºWindowsåº”ç”¨ï¼ˆä»…64ä½ï¼Œæ— å‹ç¼©æ¨¡å¼ï¼‰
          npx electron-builder --win --x64 --publish never
        env:
          # æ˜ç¡®ç¦ç”¨æ‰€æœ‰ä»£ç ç­¾åç›¸å…³ç¯å¢ƒå˜é‡
          CSC_LINK: ""
          WIN_CSC_LINK: ""
          CSC_KEY_PASSWORD: ""
          CSC_IDENTITY_AUTO_DISCOVERY: "false"
          # æ·»åŠ æ›´å¤šç¦ç”¨é€‰é¡¹
          WIN_CSC_KEY_PASSWORD: ""
          CSC_NAME: ""
          WIN_CSC_NAME: ""
          # è°ƒè¯•ä¿¡æ¯
          DEBUG: "electron-builder"
          # ç¡®ä¿ä¸ä½¿ç”¨ä»»ä½•è¯ä¹¦å­˜å‚¨
          CSC_FOR_PULL_REQUEST: "true"

      - name: List build artifacts (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "=== Release directory contents ==="
          ls -la release/ || echo "Release directory not found"
          echo "=== Build artifacts ==="
          find release/ -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.zip" -o -name "*.AppImage" \) -exec ls -lh {} \; || echo "No build artifacts found"

      - name: List build artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "=== Release directory contents ==="
          if (Test-Path "release") { Get-ChildItem -Path "release" -Force } else { Write-Host "Release directory not found" }
          Write-Host "=== Build artifacts ==="
          if (Test-Path "release") { 
            Get-ChildItem -Path "release" -Recurse -File | Where-Object { $_.Extension -in @('.dmg', '.exe', '.zip', '.AppImage') } | ForEach-Object { "{0:N2} MB  {1}" -f ($_.Length / 1MB), $_.FullName }
          } else { 
            Write-Host "No build artifacts found" 
          }

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: release/
          retention-days: 30
          if-no-files-found: error

  # è‡ªåŠ¨å‘å¸ƒ - ä»…åœ¨æ¨é€åˆ°mainæ—¶è¿è¡Œæˆ–æ‰‹åŠ¨è§¦å‘autoç±»å‹æ—¶ï¼ˆåˆ›å»ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼‰
  auto-release:
    needs: build
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'auto')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download macOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: dist-artifacts/mac

      - name: Download Windows Artifacts  
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: dist-artifacts/win

      - name: List all artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          find dist-artifacts/ -type f -exec ls -lh {} \;

      - name: Get package version
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          DATE_TIME=$(date +%Y%m%d%H%M%S)
          echo "tag=v$VERSION-$DATE_TIME" >> $GITHUB_OUTPUT
          echo "datetime=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Create Auto Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.package-version.outputs.tag }}
          name: "Auto Build v${{ steps.package-version.outputs.version }} - ${{ steps.package-version.outputs.datetime }}"
          body: |
            ğŸ¤– **è‡ªåŠ¨æ„å»ºç‰ˆæœ¬**
            
            ğŸ“… æ„å»ºæ—¶é—´: ${{ steps.package-version.outputs.datetime }}
            ğŸ“ æäº¤: ${{ github.sha }}
            ğŸ”— åˆ†æ”¯: ${{ github.ref_name }}
            
            ## ä¸‹è½½é“¾æ¥
            - ğŸ **macOS**: ä¸‹è½½ `.dmg` æ–‡ä»¶
            - ğŸªŸ **Windows**: ä¸‹è½½ `.exe` æ–‡ä»¶
            
            > âš ï¸ è¿™æ˜¯è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªå®Œå…¨æµ‹è¯•çš„åŠŸèƒ½ã€‚
          files: |
            dist-artifacts/**/*.dmg
            dist-artifacts/**/*.exe
            dist-artifacts/**/*.zip
            dist-artifacts/**/*.blockmap
          prerelease: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ­£å¼å‘å¸ƒ - ä»…åœ¨æ‰‹åŠ¨åˆ›å»ºreleaseæ—¶è¿è¡Œ
  official-release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - name: Download macOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: dist-artifacts/mac

      - name: Download Windows Artifacts  
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: dist-artifacts/win

      - name: List all artifacts
        run: |
          echo "=== Downloaded artifacts for official release ==="
          find dist-artifacts/ -type f -exec ls -lh {} \;

      - name: Attach to Official Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist-artifacts/**/*.dmg
            dist-artifacts/**/*.exe
            dist-artifacts/**/*.zip
            dist-artifacts/**/*.blockmap
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # åˆ›å»ºæ­£å¼æ ‡ç­¾ - æ‰‹åŠ¨è§¦å‘
  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'official'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Download macOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: dist-artifacts/mac

      - name: Download Windows Artifacts  
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: dist-artifacts/win

      - name: List all artifacts
        run: |
          echo "=== Downloaded artifacts for official release ==="
          find dist-artifacts/ -type f -exec ls -lh {} \;
          
      - name: Get package version
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "datetime=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
          
      - name: Create Release Tag with Artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.package-version.outputs.tag }}
          name: "v${{ steps.package-version.outputs.version }} æ­£å¼ç‰ˆ"
          body: |
            # ğŸ’¯ TestMaster AI v${{ steps.package-version.outputs.version }} æ­£å¼å‘å¸ƒ
            
            ğŸ“… å‘å¸ƒæ—¥æœŸ: ${{ steps.package-version.outputs.datetime }}
            
            ## ğŸš€ åŠŸèƒ½äº®ç‚¹
            - é«˜æ•ˆæµ‹è¯•å¤šä¸ªæç¤ºè¯æ¨¡æ¿
            - ç»“æœåˆ†æä¸å¯¹æ¯”
            - å¤šæ¨¡å‹æ”¯æŒ
            - ç›´è§‚çš„æ•°æ®å¯è§†åŒ–
            
            ## ğŸ“¦ ä¸‹è½½
            - ğŸ **macOS**: ä¸‹è½½ `.dmg` æ–‡ä»¶
            - ğŸªŸ **Windows**: ä¸‹è½½ `.exe` æ–‡ä»¶
          files: |
            dist-artifacts/**/*.dmg
            dist-artifacts/**/*.exe
            dist-artifacts/**/*.zip
            dist-artifacts/**/*.blockmap
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
