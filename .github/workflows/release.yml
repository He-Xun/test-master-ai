name: Build and Release Electron App

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'ÂèëÂ∏ÉÁ±ªÂûã'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - official

permissions:
  contents: write
  pages: write
  id-token: write

env:
  NODE_VERSION: '20'

jobs:
  # Ë∑®Âπ≥Âè∞ÊûÑÂª∫ - Êé®ÈÄÅÂà∞mainÊàñÂàõÂª∫releaseÊó∂ÈÉΩËøêË°å
  build:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: mac
            artifact-name: 'macos-build'
            icon-ext: 'icns'
          - os: windows-latest
            platform: win
            artifact-name: 'windows-build'
            icon-ext: 'ico'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print start time (before install)
        run: date

      - name: Clean node_modules and lockfile (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "Ê∏ÖÁêÜ node_modules Âíå package-lock.jsonÔºåÁ°Æ‰øù‰æùËµñÁéØÂ¢ÉÂπ≤ÂáÄÔºàWindowsÔºâ..."
          if (Test-Path "node_modules") { Remove-Item -Recurse -Force "node_modules" -ErrorAction SilentlyContinue }
          if (Test-Path "package-lock.json") { Remove-Item -Force "package-lock.json" -ErrorAction SilentlyContinue }

      - name: Install all dependencies (Windows)
        if: runner.os == 'Windows'
        timeout-minutes: 60
        run: |
          echo "ÂÆâË£ÖÂÆåÊï¥‰æùËµñÁî®‰∫éÊûÑÂª∫ÔºàWindowsÔºâ..."
          date
          npm install --prefer-offline --no-audit --progress=false --no-fund --ignore-scripts --loglevel=error --fetch-retries=5 --legacy-peer-deps
          date
        env:
          npm_config_timeout: 900000
          npm_config_maxsockets: 1
          npm_config_fetch_timeout: 600000
          npm_config_fetch_retry_mintimeout: 60000
          npm_config_fetch_retry_maxtimeout: 300000
          npm_config_registry: https://registry.npmjs.org/
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true

      - name: Install all dependencies (Unix)
        if: runner.os != 'Windows'
        timeout-minutes: 60
        run: |
          echo "ÂÆâË£ÖÂÆåÊï¥‰æùËµñÁî®‰∫éÊûÑÂª∫..."
          date
          npm install --prefer-offline --no-audit --progress=false --no-fund --ignore-scripts --loglevel=error --fetch-retries=5 --legacy-peer-deps
          date
        env:
          npm_config_timeout: 600000  # 10ÂàÜÈíüË∂ÖÊó∂
          npm_config_maxsockets: 2    # Èôç‰ΩéÂπ∂Âèë
          npm_config_fetch_timeout: 300000
          npm_config_fetch_retry_mintimeout: 30000
          npm_config_fetch_retry_maxtimeout: 120000
          npm_config_cache: .npm
          npm_config_prefer-offline: true
          npm_config_registry: https://registry.npmjs.org/
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true

      - name: Print end time (after install)
        run: date

      - name: Build renderer process with optimizations
        timeout-minutes: 30
        run: |
          echo "ÂºÄÂßãViteÊûÑÂª∫ÔºàÂêØÁî®‰ºòÂåñÔºâ..."
          npm run build:vite
        env:
          NODE_ENV: production
          CI: true
          # Vite‰ºòÂåñÈÄâÈ°π
          VITE_BUILD_MINIFY: true
          VITE_BUILD_CHUNK_SIZE_WARNING_LIMIT: 2000

      - name: Build main process
        run: npm run build:electron
        env:
          NODE_ENV: production
          CI: true

      - name: Clean up large development dependencies (Unix)
        if: runner.os != 'Windows'
        timeout-minutes: 5
        run: |
          echo "Ê∏ÖÁêÜÂ§ßÂûãÂºÄÂèë‰æùËµñÊñá‰ª∂Ôºå‰ΩÜ‰øùÁïôÊûÑÂª∫ÂøÖÈúÄÁöÑÂ∑•ÂÖ∑..."
          # Âè™Âà†Èô§ÊòéÁ°Æ‰∏çÈúÄË¶ÅÁöÑÂ§ßÊñá‰ª∂Ôºå‰øùÁïôelectronÂíåelectron-builder
          rm -rf node_modules/playwright || true
          rm -rf node_modules/puppeteer || true
          rm -rf node_modules/@playwright || true
          rm -rf node_modules/@types/puppeteer || true
          rm -rf node_modules/chromium-bidi || true
          # Ê∏ÖÁêÜ‰∏Ä‰∫õÂ§ßÁöÑÈùûÂøÖÈúÄÊñá‰ª∂
          find node_modules -name "*.d.ts" -delete || true
          find node_modules -name "README*" -delete || true
          find node_modules -name "CHANGELOG*" -delete || true
          find node_modules -name "test" -type d -exec rm -rf {} + || true
          find node_modules -name "tests" -type d -exec rm -rf {} + || true
          find node_modules -name "example" -type d -exec rm -rf {} + || true
          find node_modules -name "examples" -type d -exec rm -rf {} + || true
          echo "Ê∏ÖÁêÜÂÆåÊàêÔºå‰øùÁïôelectronÊûÑÂª∫ÂøÖÈúÄ‰æùËµñ"

      - name: Clean up large development dependencies (Windows)
        if: runner.os == 'Windows'
        timeout-minutes: 5
        shell: pwsh
        run: |
          Write-Host "Ê∏ÖÁêÜÂ§ßÂûãÂºÄÂèë‰æùËµñÊñá‰ª∂Ôºå‰ΩÜ‰øùÁïôÊûÑÂª∫ÂøÖÈúÄÁöÑÂ∑•ÂÖ∑..."
          # Âè™Âà†Èô§ÊòéÁ°Æ‰∏çÈúÄË¶ÅÁöÑÂ§ßÊñá‰ª∂Ôºå‰øùÁïôelectronÂíåelectron-builder
          if (Test-Path "node_modules/playwright") { Remove-Item -Recurse -Force "node_modules/playwright" -ErrorAction SilentlyContinue }
          if (Test-Path "node_modules/puppeteer") { Remove-Item -Recurse -Force "node_modules/puppeteer" -ErrorAction SilentlyContinue }
          if (Test-Path "node_modules/@playwright") { Remove-Item -Recurse -Force "node_modules/@playwright" -ErrorAction SilentlyContinue }
          if (Test-Path "node_modules/@types/puppeteer") { Remove-Item -Recurse -Force "node_modules/@types/puppeteer" -ErrorAction SilentlyContinue }
          if (Test-Path "node_modules/chromium-bidi") { Remove-Item -Recurse -Force "node_modules/chromium-bidi" -ErrorAction SilentlyContinue }
          
          # Ê∏ÖÁêÜ‰∏Ä‰∫õÂ§ßÁöÑÈùûÂøÖÈúÄÊñá‰ª∂
          Get-ChildItem -Path "node_modules" -Filter "*.d.ts" -Recurse | Remove-Item -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path "node_modules" -Filter "README*" -Recurse | Remove-Item -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path "node_modules" -Filter "CHANGELOG*" -Recurse | Remove-Item -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path "node_modules" -Name "test" -Directory -Recurse | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path "node_modules" -Name "tests" -Directory -Recurse | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path "node_modules" -Name "example" -Directory -Recurse | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path "node_modules" -Name "examples" -Directory -Recurse | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "Ê∏ÖÁêÜÂÆåÊàêÔºå‰øùÁïôelectronÊûÑÂª∫ÂøÖÈúÄ‰æùËµñ"

      - name: Optimize build for packaging
        run: npm run optimize:build
        env:
          NODE_ENV: production

      - name: Verify build output (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "=== Build directory contents ==="
          ls -la build/ || echo "Build directory not found"
          echo "=== Dist directory contents ==="  
          ls -la dist/ || echo "Dist directory not found"
          echo "=== Icon files ==="
          ls -la electron/icon.${{ matrix.icon-ext }} || echo "Icon file not found"
          echo "=== Node modules size ==="
          du -sh node_modules/ || echo "Node modules not found"

      - name: Verify build output (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "=== Build directory contents ==="
          if (Test-Path "build") { Get-ChildItem -Path "build" -Force } else { Write-Host "Build directory not found" }
          Write-Host "=== Dist directory contents ==="  
          if (Test-Path "dist") { Get-ChildItem -Path "dist" -Force } else { Write-Host "Dist directory not found" }
          Write-Host "=== Icon files ==="
          if (Test-Path "electron/icon.${{ matrix.icon-ext }}") { Get-ChildItem -Path "electron/icon.${{ matrix.icon-ext }}" -Force } else { Write-Host "Icon file not found" }
          Write-Host "=== Node modules size ==="
          if (Test-Path "node_modules") { [math]::Round((Get-ChildItem -Recurse node_modules | Measure-Object -Property Length -Sum).Sum / 1MB, 2).ToString() + " MB" } else { Write-Host "Node modules not found" }

      - name: Validate Electron Builder Configuration
        run: |
          echo "=== È™åËØÅ Electron Builder ÈÖçÁΩÆ ==="
          node -e "
            const config = require('./package.json').build;
            if (!config) throw new Error('Missing build configuration');
            console.log('‚úÖ Build configuration found');
            console.log('AppId:', config.appId);
            console.log('ProductName:', config.productName);
            console.log('Output Directory:', config.directories?.output);
            if (!config.appId) throw new Error('Missing appId');
            if (!config.productName) throw new Error('Missing productName');
            console.log('‚úÖ Required fields validated');
          "

      - name: Verify build integrity before packaging (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "=== È™åËØÅÊûÑÂª∫ÂÆåÊï¥ÊÄß (Windows) ==="
          Write-Host "Ê£ÄÊü•ÂøÖË¶ÅÁöÑÊûÑÂª∫Êñá‰ª∂..."
          if (Test-Path "dist/main.js") { Write-Host "‚úÖ dist/main.js exists" } else { Write-Host "‚ùå dist/main.js missing" }
          if (Test-Path "build") { Write-Host "‚úÖ build directory exists" } else { Write-Host "‚ùå build directory missing" }
          if (Test-Path "node_modules") { Write-Host "‚úÖ node_modules exists" } else { Write-Host "‚ùå node_modules missing" }
          
          Write-Host "Ê£ÄÊü•ÂõæÊ†áÊñá‰ª∂..."
          if (Test-Path "electron/icon.${{ matrix.icon-ext }}") { Write-Host "‚úÖ Icon file exists" } else { Write-Host "‚ùå Icon file missing" }
          
          Write-Host "Ê£ÄÊü•ÂÖ≥ÈîÆÊûÑÂª∫‰æùËµñ..."
          if (Test-Path "node_modules/electron") { Write-Host "‚úÖ electronÊ®°ÂùóÂ≠òÂú®" } else { Write-Host "‚ùå electronÊ®°ÂùóÁº∫Â§±" }
          if (Test-Path "node_modules/electron-builder") { Write-Host "‚úÖ electron-builderÊ®°ÂùóÂ≠òÂú®" } else { Write-Host "‚ùå electron-builderÊ®°ÂùóÁº∫Â§±" }
          
          Write-Host "Ê£ÄÊü•Â∑≤Ê∏ÖÁêÜÁöÑÂ§ßÊñá‰ª∂..."
          if (!(Test-Path "node_modules/playwright")) { Write-Host "‚úÖ playwrightÂ∑≤Ê∏ÖÁêÜ" } else { Write-Host "‚ö†Ô∏è playwright‰ªçÂ≠òÂú®" }
          if (!(Test-Path "node_modules/puppeteer")) { Write-Host "‚úÖ puppeteerÂ∑≤Ê∏ÖÁêÜ" } else { Write-Host "‚ö†Ô∏è puppeteer‰ªçÂ≠òÂú®" }
          
          Write-Host "=== Êñá‰ª∂Á≥ªÁªüÊ£ÄÊü•ÂÆåÊàê ==="

      - name: Verify build integrity before packaging (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "=== È™åËØÅÊûÑÂª∫ÂÆåÊï¥ÊÄß (Unix) ==="
          echo "Ê£ÄÊü•ÂøÖË¶ÅÁöÑÊûÑÂª∫Êñá‰ª∂..."
          [ -f dist/main.js ] && echo "‚úÖ dist/main.js exists" || echo "‚ùå dist/main.js missing"
          [ -d build ] && echo "‚úÖ build directory exists" || echo "‚ùå build directory missing"
          [ -d node_modules ] && echo "‚úÖ node_modules exists" || echo "‚ùå node_modules missing"
          
          echo "Ê£ÄÊü•ÂõæÊ†áÊñá‰ª∂..."
          [ -f electron/icon.${{ matrix.icon-ext }} ] && echo "‚úÖ Icon file exists" || echo "‚ùå Icon file missing"
          
          echo "Ê£ÄÊü•ÂÖ≥ÈîÆÊûÑÂª∫‰æùËµñ..."
          [ -d node_modules/electron ] && echo "‚úÖ electronÊ®°ÂùóÂ≠òÂú®" || echo "‚ùå electronÊ®°ÂùóÁº∫Â§±"
          [ -d node_modules/electron-builder ] && echo "‚úÖ electron-builderÊ®°ÂùóÂ≠òÂú®" || echo "‚ùå electron-builderÊ®°ÂùóÁº∫Â§±"
          
          echo "Ê£ÄÊü•Â∑≤Ê∏ÖÁêÜÁöÑÂ§ßÊñá‰ª∂..."
          [ ! -d node_modules/playwright ] && echo "‚úÖ playwrightÂ∑≤Ê∏ÖÁêÜ" || echo "‚ö†Ô∏è playwright‰ªçÂ≠òÂú®"
          [ ! -d node_modules/puppeteer ] && echo "‚úÖ puppeteerÂ∑≤Ê∏ÖÁêÜ" || echo "‚ö†Ô∏è puppeteer‰ªçÂ≠òÂú®"
          
          echo "=== Êñá‰ª∂Á≥ªÁªüÊ£ÄÊü•ÂÆåÊàê ==="

      - name: Build Electron app for macOS
        if: matrix.platform == 'mac'
        timeout-minutes: 45
        run: npx electron-builder --mac dmg --publish never
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          DEBUG: electron-builder
          # Á¶ÅÁî®macOSÂÖ¨ËØÅ‰ª•ÈÅøÂÖçÁ≠æÂêçÈóÆÈ¢ò
          CSC_LINK: ""
          CSC_KEY_PASSWORD: ""
          CSC_NAME: ""
          APPLEID: ""
          APPLEIDPASS: ""
          ASC_PROVIDER: ""
          # ÂÆåÂÖ®Ë∑≥Ëøá‰ª£Á†ÅÁ≠æÂêç
          SKIP_NOTARIZATION: true

      - name: Build Electron app for Windows  
        if: matrix.platform == 'win'
        timeout-minutes: 60
        shell: cmd
        run: |
          @echo off
          
          REM Ê∏ÖÈô§ÊâÄÊúâÂèØËÉΩÁöÑ‰ª£Á†ÅÁ≠æÂêçÁéØÂ¢ÉÂèòÈáè
          set CSC_LINK=
          set WIN_CSC_LINK=
          set CSC_KEY_PASSWORD=
          set WIN_CSC_KEY_PASSWORD=
          set CSC_NAME=
          set WIN_CSC_NAME=
          set CSC_IDENTITY_AUTO_DISCOVERY=false
          set CSC_FOR_PULL_REQUEST=true
          set DEBUG=electron-builder
          
          REM ÂºÄÂßãÊûÑÂª∫WindowsÂ∫îÁî®Ôºà‰ªÖ64‰ΩçÔºåÊó†ÂéãÁº©Ê®°ÂºèÔºâ
          npx electron-builder --win --x64 --publish never
        env:
          # ÊòéÁ°ÆÁ¶ÅÁî®ÊâÄÊúâ‰ª£Á†ÅÁ≠æÂêçÁõ∏ÂÖ≥ÁéØÂ¢ÉÂèòÈáè
          CSC_LINK: ""
          WIN_CSC_LINK: ""
          CSC_KEY_PASSWORD: ""
          CSC_IDENTITY_AUTO_DISCOVERY: "false"
          # Ê∑ªÂä†Êõ¥Â§öÁ¶ÅÁî®ÈÄâÈ°π
          WIN_CSC_KEY_PASSWORD: ""
          CSC_NAME: ""
          WIN_CSC_NAME: ""
          # Ë∞ÉËØï‰ø°ÊÅØ
          DEBUG: "electron-builder"
          # Á°Æ‰øù‰∏ç‰ΩøÁî®‰ªª‰ΩïËØÅ‰π¶Â≠òÂÇ®
          CSC_FOR_PULL_REQUEST: "true"

      - name: List build artifacts (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "=== Release directory contents ==="
          ls -la release/ || echo "Release directory not found"
          echo "=== Build artifacts ==="
          find release/ -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.AppImage" \) -exec ls -lh {} \; || echo "No build artifacts found"

      - name: List build artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "=== Release directory contents ==="
          if (Test-Path "release") { Get-ChildItem -Path "release" -Force } else { Write-Host "Release directory not found" }
          Write-Host "=== Build artifacts ==="
          if (Test-Path "release") { 
            Get-ChildItem -Path "release" -Recurse -File | Where-Object { $_.Extension -in @('.dmg', '.exe', '.zip', '.AppImage') } | ForEach-Object { "{0:N2} MB  {1}" -f ($_.Length / 1MB), $_.FullName }
          } else { 
            Write-Host "No build artifacts found" 
          }

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: release/
          retention-days: 30
          if-no-files-found: error

      - name: Copy ffmpeg.dll to release (Windows)
        if: runner.os == 'Windows'
        run: |
          $src = "node_modules\electron\dist\ffmpeg.dll"
          $dst = "release\win-unpacked\ffmpeg.dll"
          if (Test-Path $src) { Copy-Item $src $dst -Force }
          Write-Host "ffmpeg.dll copied to release/win-unpacked"

      - name: Verify ffmpeg.dll in release (Windows)
        if: runner.os == 'Windows'
        run: |
          if (Test-Path "release\win-unpacked\ffmpeg.dll") { Write-Host "‚úÖ ffmpeg.dll found in release/win-unpacked" } else { Write-Host "‚ùå ffmpeg.dll NOT found in release/win-unpacked" }

      - name: Copy sql-wasm.wasm to public (Unix)
        if: runner.os != 'Windows'
        run: cp node_modules/sql.js/dist/sql-wasm.wasm public/sql-wasm.wasm

      - name: Copy sql-wasm.wasm to public (Windows)
        if: runner.os == 'Windows'
        run: copy node_modules\sql.js\dist\sql-wasm.wasm public\sql-wasm.wasm

  # Ëá™Âä®ÂèëÂ∏É - ‰ªÖÂú®Êé®ÈÄÅÂà∞mainÊó∂ËøêË°åÊàñÊâãÂä®Ëß¶ÂèëautoÁ±ªÂûãÊó∂ÔºàÂàõÂª∫È¢ÑÂèëÂ∏ÉÁâàÊú¨Ôºâ
  auto-release:
    needs: build
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) || (github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'auto')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download macOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: dist-artifacts/mac

      - name: Download Windows Artifacts  
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: dist-artifacts/win

      - name: List all artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          find dist-artifacts/ -type f -exec ls -lh {} \;

      - name: Get package version
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          DATE_TIME=$(date +%Y%m%d%H%M%S)
          echo "tag=v$VERSION-$DATE_TIME" >> $GITHUB_OUTPUT
          echo "datetime=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Create Auto Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.package-version.outputs.tag }}
          name: "Auto Build v${{ steps.package-version.outputs.version }} - ${{ steps.package-version.outputs.datetime }}"
          body: |
            ü§ñ **Ëá™Âä®ÊûÑÂª∫ÁâàÊú¨**
            
            üìÖ ÊûÑÂª∫Êó∂Èó¥: ${{ steps.package-version.outputs.datetime }}
            üìù Êèê‰∫§: ${{ github.sha }}
            üîó ÂàÜÊîØ: ${{ github.ref_name }}
            
            ## ‰∏ãËΩΩÈìæÊé•
            - üçé **macOS**: ‰∏ãËΩΩ `.dmg` Êñá‰ª∂
            - ü™ü **Windows**: ‰∏ãËΩΩ `.exe` Êñá‰ª∂
            
            > ‚ö†Ô∏è ËøôÊòØËá™Âä®ÊûÑÂª∫ÁâàÊú¨ÔºåÂèØËÉΩÂåÖÂê´Êú™ÂÆåÂÖ®ÊµãËØïÁöÑÂäüËÉΩ„ÄÇ
          files: |
            dist-artifacts/**/*.dmg
            dist-artifacts/**/*.zip
            dist-artifacts/**/*.blockmap
          prerelease: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Ê≠£ÂºèÂèëÂ∏É - ‰ªÖÂú®ÊâãÂä®ÂàõÂª∫releaseÊó∂ËøêË°å
  official-release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'official')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download macOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: dist-artifacts/mac

      - name: Download Windows Artifacts  
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: dist-artifacts/win

      - name: List all artifacts
        run: |
          echo "=== Downloaded artifacts for official release ==="
          find dist-artifacts/ -type f -exec ls -lh {} \;

      - name: Get package version
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Attach to Official Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.package-version.outputs.tag }}
          files: |
            dist-artifacts/**/*.dmg
            dist-artifacts/**/*.zip
            dist-artifacts/**/*.blockmap
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ÂàõÂª∫Ê≠£ÂºèÊ†áÁ≠æ - ÊâãÂä®Ëß¶Âèë
  create-release:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'official'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get package version
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "datetime=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Find changelog file
        id: changelog
        run: |
          FILE=$(ls dev-management/changelog/*-v${{ steps.package-version.outputs.version }}-*.md 2>/dev/null || true)
          if [ -z "$FILE" ]; then
            echo "Êú™ÊâæÂà∞ÂØπÂ∫îÁâàÊú¨ÁöÑchangelogÊñá‰ª∂" >&2
            exit 1
          fi
          echo "file=$FILE" >> $GITHUB_OUTPUT

      - name: Read changelog content
        id: changelog_content
        run: |
          CONTENT=$(cat ${{ steps.changelog.outputs.file }})
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release Tag
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.package-version.outputs.tag }}
          name: "v${{ steps.package-version.outputs.version }} Ê≠£ÂºèÁâà"
          body: ${{ steps.changelog_content.outputs.changelog }}
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Ensure ffmpeg.dll in release
        if: runner.os == 'Windows'
        run: |
          $src = "node_modules\electron\dist\ffmpeg.dll"
          $dst = "release\win-unpacked\ffmpeg.dll"
          if (Test-Path $src) { Copy-Item $src $dst -Force }
          Write-Host "ffmpeg.dll copied to release"

      - name: Verify ffmpeg.dll in release
        if: runner.os == 'Windows'
        run: |
          if (Test-Path "release\win-unpacked\ffmpeg.dll") { Write-Host "‚úÖ ffmpeg.dll found in release/win-unpacked" } else { Write-Host "‚ùå ffmpeg.dll NOT found in release/win-unpacked" }
